---
output: html_document
editor_options: 
  chunk_output_type: console
---

## Plumbing and kitchen facilities


```{r}
#| include: false

source(here::here("r", "libraries.r"))
source(here::here("r", "functions.r"))

plumbkitch <- readRDS(here::here("data", "plumbkitch.rds"))

fplumbkitch <- plumbkitch |> 
  group_by(vdesc2, desc2) |> 
  summarise(n=n(), .groups="drop") |> 
  mutate(order=row_number()) |> 
  select(order, vdesc2, desc2)
fplumbkitch

plumbkitch_wide <- plumbkitch |> 
  # filter(nytype=="state", stabbr=="NY") |> 
  # CAUTION - drop the grand total before adding all
  filter(tenure %in% c("own", "rent")) |>
  group_by(nytype, stabbr, mininame, cntyname,
           tenure, vdesc2, desc2) |> 
  summarise(value=sum(value), .groups="drop") |> 
  select(-desc2) |> 
  pivot_wider(names_from = c(tenure, vdesc2)) |> 
  # get own and rent sums
  mutate(occ_all=own_all + rent_all,
         occ_lackplumb=own_lackplumb + rent_lackplumb) |> 
  # calc percentages
  mutate(own_pct=own_lackplumb / own_all,
         rent_pct=rent_lackplumb / rent_all,
         occ_pct=occ_lackplumb / occ_all,
         renter_share=rent_all / occ_all)

plumbkitch_wide |> filter(nytype=="region") |> 
  select(mininame, contains("pct"), renter_share)

```

```{r}
#| label: constants-plumbkitch
#| include: false

minunits <- 500
nplaces <- 25

tabst <- "Percent of occupied housing units that lack complete plumbing or kitchen facilities"

```

### Housing that lacks complete plumbing or kitchen facilities

#### New York compared to other states

```{r}
#| label: state-plumbkitch-data
#| include: false

# cost_st <- cost_wide |> 
#   filter(nytype=="state")

# own_pct30 rent_pct30 occ_pct30
# own_pct50 rent_pct50 occ_pct50

tabdata_st <-  plumbkitch_wide |> 
  filter(nytype=="state") |>
  mutate(mininame=str_remove(mininame, " State"),
         ownrank=row_number(desc(own_pct)),
         rentrank=row_number(desc(rent_pct)),
         occrank=row_number(desc(occ_pct)))  |> 
  select(stabbr, mininame, cntyname, 
         own_pct, rent_pct, occ_pct, 
         ownrank, rentrank, occrank,
         renter_share) |> 
  arrange(desc(occ_pct))
tabdata_st

# tabdata |> 
#   ggplot(aes(own_pct, rent_pct))+
#   geom_point() +
#   geom_text(aes(label=stabbr), hjust=0, vjust=0) +
#   geom_abline(slope=1, intercept=0)


```



```{r}
#| label: state-plumbkitch
#| include: true
#| echo: false

tt <- "States ranked by percent of housing units lacking complete plumbing or kitchen facilities"
tab <- ftabranks(tabdata_st, stubvar="mininame", stubhead="State",
         tabtitle=tt, tabsubtitle=tabst)
tab

```

#### Lack of complete plumbing or kitchen facilities in New York's regions

```{r}
#| label: region-plumbkitch-data
#| include: false

# count(rgns, rgn_num, rgn_osc, mininame)

tabdata_rgn <- plumbkitch_wide |> 
  filter(stabbr=="NY", nytype %in% c("state", "region")) |> 
  mutate(group=ifelse(nytype=="state", 1, 2)) |>
  group_by(group) |> 
  mutate(ownrank=row_number(desc(own_pct)),
         rentrank=row_number(desc(rent_pct)),
         occrank=row_number(desc(occ_pct))) |> 
  ungroup() |> 
  mutate(across(contains("rank"), ~ ifelse(group==1, NA_real_, .x))) |> 
  select(stabbr, mininame, cntyname, 
         own_pct, rent_pct, occ_pct, 
         ownrank, rentrank, occrank,
         renter_share) |>  
  arrange(desc(occ_pct))

tabdata_rgn

```


```{r}
#| label: region-plumbkitch
#| include: true
#| echo: false
tt <- "New York regions ranked by percent of housing units lacking complete plumbing or kitchen facilities"
tab <- ftabranks(tabdata_rgn, stubvar="mininame", stubhead="Region",
         tabtitle=tt)
tab

```

#### Lack of complete plumbing or kitchen facilities in New York's counties

```{r}
#| label: county-plumbkitch-data
#| include: false

tabdata_cnty <- plumbkitch_wide |> 
  filter(stabbr=="NY", nytype %in% c("state", "county")) |> 
  mutate(group=ifelse(nytype=="state", 1, 2)) |>
  group_by(group) |> 
  mutate(ownrank=row_number(desc(own_pct)),
         rentrank=row_number(desc(rent_pct)),
         occrank=row_number(desc(occ_pct))) |> 
  ungroup() |> 
  mutate(across(contains("rank"), ~ ifelse(group==1, NA_real_, .x))) |>  
  select(stabbr, mininame, cntyname, 
         own_pct, rent_pct, occ_pct, 
         ownrank, rentrank, occrank,
         renter_share) |>  
  arrange(desc(occ_pct))

tabdata_cnty

```

```{r}
#| label: county-plumbkitch
#| include: true
#| echo: false

tt <- "New York counties ranked by percent of housing units lacking complete plumbing or kitchen facilities"
tab <- ftabranks(tabdata_cnty, stubvar="mininame", stubhead="County",
         tabtitle=tt, tabsubtitle=tabst)
tab
```

#### Lack of complete plumbing or kitchen facilities in New York's cities

```{r}
#| label: city-plumbkitch-data
#| include: false

tabdata_city <- plumbkitch_wide |> 
  filter(stabbr=="NY", nytype %in% c("state", "city")) |>
  mutate(group=ifelse(nytype=="state", 1, 2)) |>
  group_by(group) |> 
  mutate(ownrank=row_number(desc(own_pct)),
         rentrank=row_number(desc(rent_pct)),
         occrank=row_number(desc(occ_pct))) |> 
  ungroup() |> 
  mutate(across(contains("rank"), ~ ifelse(group==1, NA_real_, .x))) |>   
  select(stabbr, mininame, cntyname, 
         own_pct, rent_pct, occ_pct, 
         ownrank, rentrank, occrank,
         renter_share) |>  
  arrange(desc(occ_pct))

tabdata_city


```


```{r}
#| label: city-plumbkitch
#| include: true
#| echo: false
tt <- "New York cities ranked by percent of housing units lacking complete plumbing or kitchen facilities"
tab <- ftabranks(tabdata_city, stubvar="mininame", stubhead="City",
         tabtitle=tt, tabsubtitle=tabst, keepcounty = TRUE)
tab
```

#### New York towns with greatest lack of complete plumbing or kitchen facilities

```{r}
#| label: town-plumbkitch-data
#| include: false

tabdata_town <- plumbkitch_wide |>  
  filter(occ_all >= minunits) |>
  filter(stabbr=="NY", nytype %in% c("state", "town")) |>
  mutate(group=ifelse(nytype=="state", 1, 2)) |>
  group_by(group) |> 
  mutate(ownrank=row_number(desc(own_pct)),
         rentrank=row_number(desc(rent_pct)),
         occrank=row_number(desc(occ_pct))) |> 
  ungroup() |> 
  mutate(across(contains("rank"), ~ ifelse(group==1, NA_real_, .x))) |>   
  select(stabbr, mininame, cntyname, 
         own_pct, rent_pct, occ_pct, 
         ownrank, rentrank, occrank,
         renter_share) |>  
  arrange(desc(occ_pct)) |> 
  filter(row_number() <= nplaces)

tabdata_town

```


Note that the town of Conewango	in Cattaraugus County has a large Amish community. Poverty rate appears to be about 32%.

```{r}
#| label: town-plumbkitch
#| include: true
#| echo: false

tt <- paste0("Towns in New York with ",
             minunits, 
             "+ housing units and greatest lack of complete plumbing or kitchen facilities")
tab <- ftabranks(tabdata_town, stubvar="mininame", stubhead="Town",
         tabtitle=tt, tabsubtitle=tabst, keepcounty = TRUE)
tab
```

#### New York villages with greatest lack of complete plumbing or kitchen facilities

Note that North Hills, Nassau County is not a poor community. Nicholas Brady (former Treasury Secretary) is from there. The high ranking in North Hills is driven by renter householdss, where approximately half lack complete plumbing or kitchen facilities. The CHAS reports 485 renter households. If they were sampled at the overall average 5% ACS rate, then there were about 25 renter households in the CHAS sample for North Hills, and they are driving the result. It's not practical to put confidence intervals around all numbers. I may need to raise my cutoff for towns and villages (currently I only include those with at least 500 households reported in the CHAS).

```{r}
#| label: village-plumbkitch-data
#| include: false

tabdata_village <- plumbkitch_wide |>  
  filter(occ_all >= minunits) |>
  filter(stabbr=="NY", nytype %in% c("state", "village")) |> 
  mutate(group=ifelse(nytype=="state", 1, 2)) |>
  group_by(group) |> 
  mutate(ownrank=row_number(desc(own_pct)),
         rentrank=row_number(desc(rent_pct)),
         occrank=row_number(desc(occ_pct))) |> 
  ungroup() |> 
  mutate(across(contains("rank"), ~ ifelse(group==1, NA_real_, .x))) |>   
  select(stabbr, mininame, cntyname, 
         own_pct, rent_pct, occ_pct, 
         ownrank, rentrank, occrank,
         renter_share) |>  
  arrange(desc(occ_pct)) |> 
  filter(row_number() <= nplaces)

tabdata_village

```

```{r}
#| label: village-plumbkitch
#| include: true
#| echo: false

tt <- paste0("Villages in New York with ",
             minunits, 
             "+ housing units and greatest lack of complete plumbing or kitchen facilities")
tab <- ftabranks(tabdata_village, stubvar="mininame", stubhead="Village",
         tabtitle=tt, tabsubtitle=tabst, keepcounty = TRUE)
tab
```

### Who has high housing costs?

\[To come - breakdowns by income and race\]
