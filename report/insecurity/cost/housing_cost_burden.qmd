---
output: html_document
editor_options: 
  chunk_output_type: console
---

## Housing cost burden

What is housing cost burden?

### Consequences of Housing Cost Burden

<!-- import -->

<!-- measures -->

<!-- thresholds -->

```{r}
#| include: false

source(here::here("r", "libraries.r"))
source(here::here("r", "functions.r"))

chdir <- here::here("data", "chas")
chdir2019 <- path(chdir, "2015-2019")

# cost <- readRDS(here::here("data", "cost.rds"))

t9 <- readRDS(path(chdir2019, "t9long.rds"))
# we need cnty, cntyname maybe shortname also

# use allrace for this set of tables
cost_wide <- t9 |> 
  filter(race=="allrace") |> 
  # filter(nytype=="state", stabbr=="NY") |> # uncomment for testing
  pivot_wider(names_from = c(tenure, cost)) |> 
  # get own and rent sums where cost burden is computable
  mutate(own_check=own_costle30 + own_costgt30le50 + own_costgt50,
         rent_check=rent_costle30 + rent_costgt30le50 + rent_costgt50,
         own_cost30=own_costgt30le50 + own_costgt50,
         rent_cost30=rent_costgt30le50 + rent_costgt50,
         alltenure_cost30=own_cost30 + rent_cost30,
         own_cost50=own_costgt50,
         rent_cost50=rent_costgt50,
         alltenure_cost50=own_cost50 + rent_cost50) |> 
  relocate(own_check, rent_check, .after=cntyname) |> 
  # calc percentages
  mutate(own_pct30=own_cost30 / own_allcost,
         rent_pct30=rent_cost30 / rent_allcost,
         alltenure_pct30=alltenure_cost30 / alltenure_allcost,
         own_pct50=own_cost50 / own_allcost,
         rent_pct50=rent_cost50 / rent_allcost,
         alltenure_pct50=alltenure_cost50 / alltenure_allcost, 
         renter_share=rent_allcost / alltenure_allcost)

# tabdata for all types
# nytype groups: state, region, county, city, town, village
tabdata <- cost_wide |> 
  filter(nytype %in% c("state", "region", "county", "city", "town", "village")) |>
  rename(own_pct=own_pct30, rent_pct=rent_pct30, alltenure_pct=alltenure_pct30) |> 
  group_by(nytype) |> 
  mutate(ownrank=row_number(desc(own_pct)),
         rentrank=row_number(desc(rent_pct)),
         alltenurerank=row_number(desc(alltenure_pct)))  |> 
  select(nytype, stabbr, mininame, cntyname, 
         alltenure_allcost,
         own_pct, rent_pct, alltenure_pct, 
         ownrank, rentrank, alltenurerank,
         renter_share) |> 
  ungroup() |> 
  arrange(desc(alltenure_pct))

```

```{r}
#| label: constants
#| include: false

minunits <- 500
nplaces <- 25

tabst <- "Percent of occupied housing units with housing costs greater than 30% of income"

```

### Housing cost burden

#### New York compared to other states

```{r}
#| label: state-cost-data
#| include: false

tabdata_st <- tabdata |> 
  filter(nytype=="state") |> 
  mutate(mininame=str_remove(mininame, " State"))

# tabdata |> 
#   ggplot(aes(own_pct, rent_pct))+
#   geom_point() +
#   geom_text(aes(label=stabbr), hjust=0, vjust=0) +
#   geom_abline(slope=1, intercept=0)


```

New York has the fourth highest cost burden among the states, measured by the percentage of households with costs greater than 30 percent of income. New York ranks #4 rank for both owners and renters. As is true of every state, the share of New York's renters who are cost burdened is far greater than the share of owners.

```{r}
#| label: state-cost
#| include: true
#| echo: false

tt <- "States ranked by housing cost burden"
tab <- ftabranks(tabdata_st, stubvar="mininame", stubhead="State",
         tabtitle=tt, tabsubtitle=tabst)
tab

```

#### Housing cost burden in New York's regions

```{r}
#| label: region-cost-data
#| include: false

tabdata_rgn <- tabdata |> 
  filter(stabbr=="NY", nytype %in% c("state", "region")) |>  
  mutate(across(contains("rank"), ~ ifelse(nytype=="state", NA_real_, .x)))

tabdata_rgn

```

High housing cost burden is far more prevalent in New York City, the Mid-Hudson region, and Long Island than in upstate New York. In all regions, high cost burden for renters is more prevalent than it is for homeowners; this is particularly true in upstate regions.

```{r}
#| label: region-cost
#| include: true
#| echo: false

tt <- "New York regions ranked by housing cost burden"
tab <- ftabranks(tabdata_rgn, stubvar="mininame", stubhead="Region",
         tabtitle=tt)
tab

```

#### Housing cost burden in New York's counties

```{r}
#| label: county-cost-data
#| include: false

tabdata_cnty <- tabdata |> 
  filter(stabbr=="NY", nytype %in% c("state", "county")) |>  
  mutate(across(contains("rank"), ~ ifelse(nytype=="state", NA_real_, .x)))

tabdata_cnty

```

```{r}
#| label: county-cost
#| include: true
#| echo: false
tt <- "Counties in New York ranked by housing cost burden"
tab <- ftabranks(tabdata_cnty, stubvar="mininame", stubhead="County",
         tabtitle=tt, tabsubtitle=tabst)
tab
```

#### Housing cost burden in New York's cities

```{r}
#| label: city-cost-data
#| include: false

tabdata_city <- tabdata |> 
  filter(stabbr=="NY", nytype %in% c("state", "city")) |>  
  mutate(across(contains("rank"), ~ ifelse(nytype=="state", NA_real_, .x)))

tabdata_city


```

Note the high cost burden for Ithaca in Tompkins County. This probably is an artifact of the high student population in Ithaca, where Cornell University and Ithaca College are located. *(It might make sense to examine differences by age.)*

```{r}
#| label: city-cost
#| include: true
#| echo: false

tt <- "Cities in New York ranked by housing cost burden"
tab <- ftabranks(tabdata_city, stubvar="mininame", stubhead="City",
         tabtitle=tt, tabsubtitle=tabst, keepcounty = TRUE)
tab
```

#### New York towns with greatest housing cost burden

```{r}
#| label: town-cost-data
#| include: false

tabdata_town <- tabdata |> 
  filter(stabbr=="NY", nytype %in% c("state", "town"))  |> 
  filter(alltenure_allcost >= minunits) |> 
  filter(row_number() <= nplaces) |>  
  mutate(across(contains("rank"), ~ ifelse(nytype=="state", NA_real_, .x)))

tabdata_town

```

Note that the town of Le Ray in Jefferson County is ranked in #5 overall (owners plus renters) among towns with 500+ housing units but is ranked much further down for owners only and for renters only. *This is not an error.* It is a result of Le Ray's extremely high percentage of renters, which means that the overall weighted value for all households is high because cost-burdened households generally are a much larger share for renters than for owners.

```{r}
#| label: town-cost
#| include: true
#| echo: false

tt <- paste0("Towns in New York with ",
             minunits, 
             "+ housing units and greatest housing cost burden")
tab <- ftabranks(tabdata_town, stubvar="mininame", stubhead="Town",
         tabtitle=tt, tabsubtitle=tabst, keepcounty = TRUE)
tab
```

#### New York villages with greatest housing cost burden

```{r}
#| label: village-cost-data
#| include: false

tabdata_village <- tabdata |> 
  filter(stabbr=="NY", nytype %in% c("state", "village"))  |> 
  filter(alltenure_allcost >= minunits) |> 
  filter(row_number() <= nplaces) |>  
  mutate(across(contains("rank"), ~ ifelse(nytype=="state", NA_real_, .x)))

tabdata_village

```

```{r}
#| label: village-cost
#| include: true
#| echo: false

tt <- paste0("Villages in New York with ",
             minunits, 
             "+ housing units and greatest housing cost burden")
tab <- ftabranks(tabdata_village, stubvar="mininame", stubhead="Village",
         tabtitle=tt, tabsubtitle=tabst, keepcounty = TRUE)
tab
```

### Who has high housing costs?

\[To come - breakdowns by income and race\]
