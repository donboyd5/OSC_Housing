---
output: html_document
editor_options: 
  chunk_output_type: console
---

## Housing Costs and Consequences

<!-- import -->

<!-- measures -->

<!-- thresholds -->

```{r}
#| include: false

source(here::here("r", "libraries.r"))
source(here::here("r", "functions.r"))

cost <- readRDS(here::here("data", "cost.rds"))

fcost <- cost |> 
  group_by(vdesc3, desc3) |> 
  summarise(n=n(), .groups="drop") |> 
  mutate(order=row_number()) |> 
  select(order, vdesc3, desc3)
fcost

cost_wide <- cost |> 
  # filter(nytype=="state", stabbr=="NY") |> 
  # CAUTION - drop the grand total before adding all
  filter(tenure %in% c("own", "rent")) |>
  group_by(nytype, stabbr, mininame, cntyname,
           tenure, vdesc3, desc3) |> 
  summarise(value=sum(value), .groups="drop") |> 
  select(-desc3) |> 
  pivot_wider(names_from = c(tenure, vdesc3)) |> 
  # get own and rent sums where cost burden is computable
  mutate(occ_all=own_all + rent_all,
         own_check=own_costle30 + own_costgt30le50 + own_costgt50,
         rent_check=rent_costle30 + rent_costgt30le50 + rent_costgt50,
         own_cost30=own_costgt30le50 + own_costgt50,
         rent_cost30=rent_costgt30le50 + rent_costgt50,
         occ_cost30=own_cost30 + rent_cost30,
         own_cost50=own_costgt50,
         rent_cost50=rent_costgt50,
         occ_cost50=own_cost50 + rent_cost50) |> 
  # calc percentages
  mutate(own_pct30=own_cost30 / own_all,
         rent_pct30=rent_cost30 / rent_all,
         occ_pct30=occ_cost30 / occ_all,
         own_pct50=own_cost50 / own_all,
         rent_pct50=rent_cost50 / rent_all,
         occ_pct50=occ_cost50 / occ_all, 
         renter_share=rent_all / occ_all)

# cost_wide |> select(-c(nytype, mininame, cntyname, rgn_num, rgn_oscQ)) |>
#   pivot_longer(contains("_"))
cost_wide |> filter(nytype=="region")

```

```{r}
#| label: constants
#| include: false

minunits <- 500
nplaces <- 25

tabst <- "Percent of occupied housing units with housing costs greater than 30% of income"

```

### Housing cost burden

#### New York compared to other states

```{r}
#| label: state-cost-data
#| include: false

# cost_st <- cost_wide |> 
#   filter(nytype=="state")

# own_pct30 rent_pct30 occ_pct30
# own_pct50 rent_pct50 occ_pct50

tabdata_st <-  cost_wide |> 
  filter(nytype=="state") |> 
  rename(own_pct=own_pct30, rent_pct=rent_pct30, occ_pct=occ_pct30) |> 
  mutate(mininame=str_remove(mininame, " State"),
         ownrank=row_number(desc(own_pct)),
         rentrank=row_number(desc(rent_pct)),
         occrank=row_number(desc(occ_pct)))  |> 
  select(stabbr, mininame, cntyname, 
         own_pct, rent_pct, occ_pct, 
         ownrank, rentrank, occrank,
         renter_share) |> 
  arrange(desc(occ_pct))
tabdata_st

# tabdata |> 
#   ggplot(aes(own_pct, rent_pct))+
#   geom_point() +
#   geom_text(aes(label=stabbr), hjust=0, vjust=0) +
#   geom_abline(slope=1, intercept=0)


```

New York has the fourth highest cost burden among the states, measured by the percentage of households with costs greater than 30 percent of income. New York ranks #4 rank for both owners and renters. As is true of every state, the share of New York's renters who are cost burdened is far greater than the share of owners.

```{r}
#| label: state-cost
#| include: true
#| echo: false

tt <- "States ranked by housing cost burden"
tab <- ftabranks(tabdata_st, stubvar="mininame", stubhead="State",
         tabtitle=tt, tabsubtitle=tabst)
tab

```

#### Housing cost burden in New York's regions

```{r}
#| label: region-cost-data
#| include: false

# count(rgns, rgn_num, rgn_osc, mininame)

tabdata_rgn <- cost_wide |> 
  filter(stabbr=="NY", nytype %in% c("state", "region")) |>  
  rename(own_pct=own_pct30, rent_pct=rent_pct30, occ_pct=occ_pct30) |> 
  mutate(group=ifelse(nytype=="state", 1, 2)) |>
  group_by(group) |> 
  mutate(ownrank=row_number(desc(own_pct)),
         rentrank=row_number(desc(rent_pct)),
         occrank=row_number(desc(occ_pct))) |> 
  ungroup() |> 
  mutate(across(contains("rank"), ~ ifelse(group==1, NA_real_, .x))) |> 
  select(stabbr, mininame, cntyname, 
         own_pct, rent_pct, occ_pct, 
         ownrank, rentrank, occrank,
         renter_share) |>  
  arrange(desc(occ_pct))

tabdata_rgn

```

High housing cost burden is far more prevalent in New York City, the Mid-Hudson region, and Long Island than in upstate New York. In all regions, high cost burden for renters is more prevalent than it is for homeowners; this is particularly true in upstate regions.

```{r}
#| label: region-cost
#| include: true
#| echo: false

tt <- "New York regions ranked by housing cost burden"
tab <- ftabranks(tabdata_rgn, stubvar="mininame", stubhead="Region",
         tabtitle=tt)
tab

```

#### Housing cost burden in New York's counties

```{r}
#| label: county-cost-data
#| include: false

tabdata_cnty <- cost_wide |> 
  filter(stabbr=="NY", nytype %in% c("state", "county")) |>   
  rename(own_pct=own_pct30, rent_pct=rent_pct30, occ_pct=occ_pct30) |> 
  mutate(group=ifelse(nytype=="state", 1, 2)) |>
  group_by(group) |> 
  mutate(ownrank=row_number(desc(own_pct)),
         rentrank=row_number(desc(rent_pct)),
         occrank=row_number(desc(occ_pct))) |> 
  ungroup() |> 
  mutate(across(contains("rank"), ~ ifelse(group==1, NA_real_, .x))) |>  
  select(stabbr, mininame, cntyname, 
         own_pct, rent_pct, occ_pct, 
         ownrank, rentrank, occrank,
         renter_share) |>  
  arrange(desc(occ_pct))

tabdata_cnty

```

```{r}
#| label: county-cost
#| include: true
#| echo: false
tt <- "Counties in New York ranked by housing cost burden"
tab <- ftabranks(tabdata_cnty, stubvar="mininame", stubhead="County",
         tabtitle=tt, tabsubtitle=tabst)
tab
```

#### Housing cost burden in New York's cities

```{r}
#| label: city-cost-data
#| include: false

tabdata_city <- cost_wide |> 
  filter(stabbr=="NY", nytype %in% c("state", "city")) |>    
  rename(own_pct=own_pct30, rent_pct=rent_pct30, occ_pct=occ_pct30) |> 
  mutate(group=ifelse(nytype=="state", 1, 2)) |>
  group_by(group) |> 
  mutate(ownrank=row_number(desc(own_pct)),
         rentrank=row_number(desc(rent_pct)),
         occrank=row_number(desc(occ_pct))) |> 
  ungroup() |> 
  mutate(across(contains("rank"), ~ ifelse(group==1, NA_real_, .x))) |>   
  select(stabbr, mininame, cntyname, 
         own_pct, rent_pct, occ_pct, 
         ownrank, rentrank, occrank,
         renter_share) |>  
  arrange(desc(occ_pct))

tabdata_city


```

Note the high cost burden for Ithaca in Tompkins County. This probably is an artifact of the high student population in Ithaca, where Cornell University and Ithaca College are located. *(It might make sense to examine differences by age.)*

```{r}
#| label: city-cost
#| include: true
#| echo: false

tt <- "Cities in New York ranked by housing cost burden"
tab <- ftabranks(tabdata_city, stubvar="mininame", stubhead="City",
         tabtitle=tt, tabsubtitle=tabst, keepcounty = TRUE)
tab
```

#### New York towns with greatest housing cost burden

```{r}
#| label: town-cost-data
#| include: false

tabdata_town <- cost_wide |>  
  filter(occ_all >= minunits) |>
  filter(stabbr=="NY", nytype %in% c("state", "town")) |>    
  rename(own_pct=own_pct30, rent_pct=rent_pct30, occ_pct=occ_pct30) |> 
  mutate(group=ifelse(nytype=="state", 1, 2)) |>
  group_by(group) |> 
  mutate(ownrank=row_number(desc(own_pct)),
         rentrank=row_number(desc(rent_pct)),
         occrank=row_number(desc(occ_pct))) |> 
  ungroup() |> 
  mutate(across(contains("rank"), ~ ifelse(group==1, NA_real_, .x))) |>   
  select(stabbr, mininame, cntyname, 
         own_pct, rent_pct, occ_pct, 
         ownrank, rentrank, occrank,
         renter_share) |>  
  arrange(desc(occ_pct)) |> 
  filter(row_number() <= nplaces)

tabdata_town

```

Note that the town of Le Ray in Jefferson County is ranked 5th overall (owners plus renters) among towns with 500+ housing units but is ranked much further down for owners only and for renters only. *This is not an error.* It is a result of Le Ray's extremely high percentage of renters, which means that the overall weighted value for all households is high because cost-burdened households generally are a much larger share for renters than for owners.

```{r}
#| label: town-cost
#| include: true
#| echo: false

tt <- paste0("Towns in New York with ",
             minunits, 
             "+ housing units and greatest housing cost burden")
tab <- ftabranks(tabdata_town, stubvar="stub", stubhead="Town",
         tabtitle=tt, tabsubtitle=tabst, keepcounty = TRUE)
tab
```

#### New York villages with greatest housing cost burden

```{r}
#| label: village-cost-data
#| include: false

tabdata_village <- cost_wide |>  
  filter(occ_all >= minunits) |>
  filter(stabbr=="NY", nytype %in% c("state", "village")) |>    
  rename(own_pct=own_pct30, rent_pct=rent_pct30, occ_pct=occ_pct30) |> 
  mutate(group=ifelse(nytype=="state", 1, 2)) |>
  group_by(group) |> 
  mutate(ownrank=row_number(desc(own_pct)),
         rentrank=row_number(desc(rent_pct)),
         occrank=row_number(desc(occ_pct))) |> 
  ungroup() |> 
  mutate(across(contains("rank"), ~ ifelse(group==1, NA_real_, .x))) |>   
  select(stabbr, mininame, cntyname, 
         own_pct, rent_pct, occ_pct, 
         ownrank, rentrank, occrank,
         renter_share) |>  
  arrange(desc(occ_pct)) |> 
  filter(row_number() <= nplaces)

tabdata_village

```

```{r}
#| label: village-cost
#| include: true
#| echo: false

tt <- paste0("Villages in New York with ",
             minunits, 
             "+ housing units and greatest housing cost burden")
tab <- ftabranks(tabdata_village, stubvar="mininame", stubhead="Village",
         tabtitle=tt, tabsubtitle=tabst, keepcounty = TRUE)
tab
```

### Who has high housing costs?

\[To come - breakdowns by income and race\]
