---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Housing Cost Burden in New York
<!-- #| echo: false -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- #| note: false -->


Housing cost burden, owners and renters, by county

![housing cost burden, owners and renters](images/paste-CBC499D7.png)



```{r}
#| label: libraries_and_load
#| eval: false
#| include: false

# libraries ---------------------------------------------------------------
source(here::here("r", "libraries.r"))
source(here::here("r", "libraries_maps.r"))
source(here::here("r", "functions_maps.r"))

# locations --------------------------------------------------------------
# acsdir <- here::here("data", "acs")


# get data ----------------------------------------------------------------
nycentroids <- readRDS(here::here("data", "maps", "nycentroids.rds"))
nygeom <- readRDS(here::here("data", "maps", "nycentroids.rds"))
xwalk <- readRDS(here::here("data", "crosswalks", "nycounty_xwalk.rds"))
nycos_shape <- readRDS(here::here("data", "maps", "nycos_shape.rds"))
acsdata <- readRDS(here::here("data", "acs", "acsdata.rds"))


```

```{r}
#| eval: false
#| include: false

# prep data
# B25106  TENURE BY HOUSING COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME IN THE PAST 12 MONTHS       

hcburden1 <- acsdata |> 
  filter(table=="B25106") |> 
  mutate(line=as.numeric(line))
count(hcburden1, stub)

# hcburden1 |> 
#   filter(line %in% c(1, 2, 24), geoid=="36001")


incstubs <- hcburden1 |> 
  filter(geoid=="36001",
         (line %in% c(1, 2, 24)) |
           (line %in% 25:41 & str_detect(stub, coll("$"))) |
              (line==45)) |> 
  select(line, vname, stub) |> 
  arrange(line) |> 
  mutate(order=row_number(),
         label=ifelse(line %in% c(1, 2, 24), "Total", str_remove(stub, ":")),
         incname=factor(order, 
                        levels=1:9, 
                        labels=c("allincome", "allincome", "allincome",  
                                 "lt20k", "ge20lt35k", "ge35lt50k", "ge50lt75k", "ge75k",
                                 "znegincome")))
incstubs  

hcstubs <- hcburden1 |> 
  filter(line %in% c(1, 2, 24, 42:46), geoid=="36001") |> 
  select(line, vname, stub) |> 
  arrange(line) |> 
  mutate(order=row_number(),
         label=ifelse(line %in% c(1, 2, 24), "Total", stub),
         hcname=factor(order,
                       levels=1:8, 
                       labels=c("allcosts", "allcosts", "allcosts", "lt20p", "ge20lt30p", "ge30p", "znegincome", "norent")))
hcstubs  


stubdefs <- read_delim(
"line	tenure	income	hcosts
1	all	all	all
2	own	all	all
3	own	lt20k	all
4	own	lt20k	lt20p
5	own	lt20k	ge20lt30p
6	own	lt20k	ge30p
7	own	ge20lt35k	all
8	own	ge20lt35k	lt20p
9	own	ge20lt35k	ge20lt30p
10	own	ge20lt35k	ge30p
11	own	ge35lt50k	all
12	own	ge35lt50k	lt20p
13	own	ge35lt50k	ge20lt30p
14	own	ge35lt50k	ge30p
15	own	ge50lt75k	all
16	own	ge50lt75k	lt20p
17	own	ge50lt75k	ge20lt30p
18	own	ge50lt75k	ge30p
19	own	ge75k	all
20	own	ge75k	lt20p
21	own	ge75k	ge20lt30p
22	own	ge75k	ge30p
23	own	znegincome	znegincome
24	rent	all	all
25	rent	lt20k	all
26	rent	lt20k	lt20p
27	rent	lt20k	ge20lt30p
28	rent	lt20k	ge30p
29	rent	ge20lt35k	all
30	rent	ge20lt35k	lt20p
31	rent	ge20lt35k	ge20lt30p
32	rent	ge20lt35k	ge30p
33	rent	ge35lt50k	all
34	rent	ge35lt50k	lt20p
35	rent	ge35lt50k	ge20lt30p
36	rent	ge35lt50k	ge30p
37	rent	ge50lt75k	all
38	rent	ge50lt75k	lt20p
39	rent	ge50lt75k	ge20lt30p
40	rent	ge50lt75k	ge30p
41	rent	ge75k	all
42	rent	ge75k	lt20p
43	rent	ge75k	ge20lt30p
44	rent	ge75k	ge30p
45	rent	znegincome	znegincome
46	rent	norent	norent
")
stubdefs

incomelevs <- stubdefs |> 
  select(line, income) |> 
  group_by(income) |> 
  arrange(line) |> 
  filter(row_number()==1) |> 
  ungroup() |> 
  arrange(line) |> 
  mutate(order=row_number())
incomelevs

hcostlevs <- stubdefs |> 
  select(line, hcosts) |> 
  group_by(hcosts) |> 
  arrange(line) |> 
  filter(row_number()==1) |> 
  ungroup() |> 
  arrange(line) |> 
  mutate(order=row_number())
hcostlevs


hcburden2 <- hcburden1 |> 
  left_join(stubdefs, by = "line") |> 
  mutate(income=factor(income, levels=incomelevs$income),
         hcosts=factor(hcosts, levels=hcostlevs$hcosts))

hcwide <- hcburden2 |> 
  filter(type=="county") |> 
  select(geoid, line, tenure, income, hcosts, estimate)

```



```{r}
#| label: map_data
#| eval: false
#| include: false


# get total percentages ----------------------------------------
count(acsdata, type)

df1 <- acsdata |> 
  filter(table=="B25003")

ownpct <- df1 |> 
  mutate(var=factor(line, levels=1:3, labels=c("total", "owner", "renter"))) |> 
  select(type, geoid, area, var, estimate) |> 
  pivot_wider(names_from = var, values_from = estimate) |> 
  mutate(ownpct=owner / total,
         rentpct=renter / total)

# |> left_join(xwalk, by="geoid")
# names(mapdata)
# count(mapdata, area, costate)

```



```{r}
#| label: county_tenure_map
#| eval: false
#| fig-width: 12
#| fig-height: 12
#| include: true

mdata <- nycos_shape |>
  left_join(mapdata |> select(-area), by="geoid")
  
p1 <- mdata |> 
  ggplot() +
  geom_sf(aes(fill=rentpct)) +
  scale_fill_distiller(palette = "BrBG", 
                       direction=1, 
                       breaks=seq(0, 1, .1), 
                       labels = scales::percent_format(accuracy = 1)) +
  theme_map() + 
  ggtitle("Renter households as percentage of occupied housing") + 
  theme(plot.title=element_text(size=30)) +
  labs(fill="Renter %") +
  geom_text(aes(xlabel, ylabel, label = area), 
             size = 3, fontface = "bold", colour="blue",
             label.padding = unit(0.1, "lines"), # default 0.25
             label.size = 0.15,) + # default 0.25
  theme(legend.position = c(0.9, 0.45)) +
  theme(legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(1, 'cm'), #change legend key height
        legend.key.width = unit(1, 'cm'), #change legend key width
        legend.title = element_text(size=14), #change legend title font size
        legend.text = element_text(size=10))

p1



# p1 <- nycomap(mapdata, mapvar="rentpct", maptitle="Renter percentage by county", direction = 1)
# p1
# ggsave(here::here("report", "results", "owners_hhpct.png"), p, width = 10, height = 6, scale=1.5)

```



```{r}
#| label: cities_tenure_map
#| eval: false
#| fig-width: 12
#| fig-height: 12
#| out-width: 12in
#| include: true

bubble_data <- nycentroids |> 
  filter(atype=="cousub", str_detect(area, "city")) |> 
  arrange(desc(pop5yr)) |> 
  filter(row_number() <= 15) |> 
  left_join(ownpct |> select(geoid, ownpct, rentpct), by="geoid") |> 
  mutate(aname=str_remove(area, " city"))

# mdata <- nycos_shape |>
#     left_join(ownpct |> select(-area), by="geoid")
  
p2 <- nycos_shape |> 
  ggplot() +
  geom_sf(fill="grey99") +
  geom_point(aes(x=loncenter, y=latcenter, size=pop5yr, colour=rentpct), alpha=0.5, stroke=FALSE, data=bubble_data) +
  scale_size_continuous(range = c(3, 8)) +
  scale_colour_distiller(palette = "BrBG", 
                       direction=1, 
                       breaks=seq(0, 1, .1), 
                       labels = scales::percent_format(accuracy = 1)) +
  geom_text_repel(aes(x=loncenter, y=latcenter, label=aname), size=4, data=bubble_data) + 
  ggtitle("Renter households as percentage of occupied housing",
          subtitle="Largest cities outside New York City") + 
  labs(size="Population", colour="Renter %") +
  theme_map() +
  theme(plot.title=element_text(size=30),
        plot.subtitle=element_text(size=20)) +
  theme(legend.position = c(0.9, 0.45)) +
  theme(legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(1, 'cm'), #change legend key height
        legend.key.width = unit(1, 'cm'), #change legend key width
        legend.title = element_text(size=14), #change legend title font size
        legend.text = element_text(size=10))
p2 

```


```{r}
#| label: counties_cities_tenure_map
#| fig-width: 16
#| fig-height: 16
#| eval: false
#| include: false
# p1 + p2

```


```{r}
#| label: county_table
#| eval: false

tabdata <- ownpct |> 
  filter(type=="county") |> 
  mutate(aname=str_remove(area, " County, New York")) |> 
  arrange(desc(rentpct))

tab <- tabdata |> 
  select(aname, owner, renter, total, rentpct) |> 
  gt() |> 
  tab_header(
    title = "Owner and renter occupied households in New York State by county",
    subtitle = "Source: 5-year ACS ending 2020"
  ) |> 
  tab_spanner(columns = c(owner, renter, total),
              label="Number of households") |> 
  cols_label(aname="County",
             rentpct = html("Renter households<br>as % of total")) |> 
  fmt_number(columns=c(owner, renter, total),
             decimals=0) |> 
  fmt_percent(columns=rentpct, decimals=1)
tab  

```



```{r}
#| label: city_table
#| eval: false

tabdata <- nycentroids |> 
  filter(atype=="cousub", str_detect(area, "city"), geoid!="3609928640") |> # drop Geneva in Fulton
  select(geoid, area, county) |> 
  mutate(area=str_remove(area, " city")) |> 
  left_join(ownpct |> select(-area), by = "geoid") |> 
  left_join(ownpct |> 
              filter(type=="county") |> 
              select(county=area, cntyrentpct=rentpct) |> 
              mutate(county=str_remove(county, " County, New York")),
            by = "county") |> 
  arrange(desc(rentpct))

tab <- tabdata |> 
  select(area, owner, renter, total, rentpct, county, cntyrentpct) |> 
  gt() |> 
  tab_header(
    title = "Owner and renter occupied households in New York State by city (outside NYC)",
    subtitle = "Source: 5-year ACS ending 2020"
  ) |> 
  tab_spanner(columns = c(owner, renter, total),
              label="Number of households in the city") |> 
  tab_spanner(columns = c(county, cntyrentpct),
              label="County name and rental percent") |> 
  cols_label(area="City",
             rentpct = html("Renter households<br>as % of total")) |> 
  fmt_number(columns=c(owner, renter, total),
             decimals=0) |> 
  fmt_percent(columns=c(rentpct, cntyrentpct), decimals=1)
tab  

 
```

