
# table info ----
# Title	Description	Universe
## Table 1	 Tenure (2) by Housing Unit Problems (2) by Household Income (5) by Race (6)	Universe: All occupied housing units ----
## Table 2	 Tenure (2) by Severe Housing Unit Problems (2) by Household Income (5) by Race (6)	Universe: All occupied housing units ----
## Table 3	 Tenure (2) by Housing Unit Problem Severity (7) by Household Income (5)	Universe: All occupied housing units ----
## Table 4	 Tenure (2) by Housing Unit Problems (3) by Household Type (3) by Household Size (2)	Universe: All occupied housing units ----
## Table 5	 Tenure (2) by Housing Unit Problems (3) by Household Income (5) by Elderly Status (3)	Universe: All occupied housing units ----
## Table 6	 Tenure (2) by Disability Status (5) by Household Income (4) by Housing Unit Problems (3)	Universe: All occupied housing units ----
## Table 7	 Tenure (2) by Household Income (5) by Household Type (5) by Housing Cost Burden (3)	Universe: All occupied housing units ----
## Table 8	 Tenure (2) by Household Income (5) by Housing Cost Burden (4) by Substandard Housing (2)	Universe: All occupied housing units ----
## Table 9	 Tenure (2) by Race (7) by Housing Cost Burden (4)	Universe: All occupied housing units ----
## Table 10	 Tenure (2) by Overcrowding (3) by Household Income (5) by Family Status (3)	Universe: All occupied housing units ----
## Table 11	 Tenure (2) by Housing Unit Problems (3) by Household Income (13)	Universe: All occupied housing units ----
## Table 12	 Tenure (2) by Year Structure Built (5) by Household Income (4b) by Housing Cost Burden (3)	Universe: All occupied housing units ----
## Table 13	 Tenure (2) by Year Structure Built (3) by Household Income (5) by Presence of Children (2)	Universe: All occupied housing units ----
## Table 14A	 Substandard Housing (2) by Owner Affordability (4) by Bedrooms (3)	Universe: All vacant for-sale housing units ----
## Table 14B	 Substandard Housing (2) by Renter Affordability (4) by Bedrooms (3)	Universe: All vacant for-rent housing units ----
## Table 15A	 Substandard Housing (2) by Owner Affordability (4) by Household Income (5)  by Bedrooms (3)	Universe: All owner occupied housing units with a mortgage ----
## Table 15B	 Substandard Housing (2) by Owner Affordability (4) by Household Income (5)  by Bedrooms (3)	Universe: All owner occupied housing units without a mortgage ----
## Table 15C	 Substandard Housing (2) by Renter Affordability (4) by Household Income (5) Bedrooms (3)	Universe: All renter occupied housing units ----
## Table 16	 Tenure (2) by Housing Income (4a) by Household Type (5) by Housing Unit Problems (3) (2000 comparison)	Universe: All occupied housing units ----
## Table 17A	 Units in Structure (4) by Owner Affordability (4)	Universe: All vacant for-sale housing units ----
## Table 17B	 Units in Structure (4) by Renter Affordability (4)	Universe: All vacant for-rent housing units ----
## Table 18A	 Units in Structure (4) by Owner Affordability (4) by Household Income (5)	Universe: All owner occupied housing units with a mortgage ----
## Table 18B	 Units in Structure (4) by Owner Affordability (4) by Household Income (5)	Universe: All owner occupied housing units without a mortgage ----
## Table 18C	 Units in Structure (4) by Renter Affordability (4) by Household Income (5)	Universe: All renter occupied housing units ----

# variables ---------------------------------------------------------------
## Bedrooms (3) ----
# 1 or fewer bedrooms
# 2 bedrooms
# 3 or more bedrooms
# 
## Disability Status (5) ----
# Household member has a hearing or vision impairment
# Household member has an ambulatory limitation
# Household member has a cognitive limitation
# Household member has a self-care or independent living limitation
# Household member has none of the above limitations
# 
## Elderly Status (3) ----
# Household contains at least 1 person age 62-74 but no one age 75+ (Elderly household)
# Household contains at least 1 person age 75+ (Extra-elderly household)
# Household contains no one age 62+ (Non-elderly household)
# 
## Family Status (3) ----
# 1 family household
# Multi-family household
# Nonfamily household
# 
## Household Income (4) ----
# Household income is less than or equal to 30% of HUD area median family income
# Household income is greater than 30% but less than or equal to 50% of HAMFI
# Household income is greater than 50% but less than or equal to 80% of HAMFI
# Household income is greater than 80% of HAMFI
# 
## Household Income (4b) ----
# Household income is less than or equal to 50% of HUD area median family income
# Household income is greater than 50% but less than or equal to 80% of HAMFI
# Household income is greater than 80% but less than or equal to 120% of HAMFI
# Household income is greater than 120% of HAMFI
# 
## Household Income (5) ----
# Household income is less than or equal to 30% of HUD area median family income
# Household income is greater than 30% but less than or equal to 50% of HAMFI
# Household income is greater than 50% but less than or equal to 80% of HAMFI
# Household income is greater than 80% but less than or equal to 100% of HAMFI
# Household income is greater than 100% of HAMFI
# 
## Household Income (13) ----
# Household income is less than or equal to 20% of HUD area median family income
# Household income is greater than 20% but less than or equal to 30% of HAMFI
# Household income is greater than 30% but less than or equal to 40% of HAMFI
# Household income is greater than 40% but less than or equal to 50% of HAMFI
# Household income is greater than 50% but less than or equal to 60% of HAMFI
# Household income is greater than 60% but less than or equal to 65% of HAMFI
# Household income is greater than 65% but less than or equal to 80% of HAMFI
# Household income is greater than 80% but less than or equal to 95% of HAMFI
# Household income is greater than 95% but less than or equal to 100% of HAMFI
# Household income is greater than 100% but less than or equal to 115% of HAMFI
# Household income is greater than 115% but less than or equal to 120% of HAMFI
# Household income is greater than 120% but less than or equal to 140% of HAMFI
# Household income is greater than 140% of HAMFI
# 
## Household Size (2) ----
# 4 or fewer persons
# 5 or more persons
# 
## Household Type (3) ----
# Single parent family household
# Two parent family household
# Other household
# 
## Household Type (5) ----
# Elderly family households (household contains 2 persons, with either or both age 62 or over)
# Small family household (2 persons, neither person 62 years or over, or 3 or 4 persons)
# Large family households (5 or more persons)
# Elderly nonfamily households (1 or 2 person nonfamily households with either person 62 years or over)
# Other nonfamily households

## Housing Cost Burden (3) ----
# Cost burden is less than or equal to 30%
# Cost burden is greater than 30%, less than or equal to 50%
#   Cost burden is greater than 50%
 
## Housing Cost Burden (4) ----
# Cost burden is less than or equal to 30%
# Cost burden is greater than 30%, less than or equal to 50%
#   Cost burden is greater than 50%
# Cost burden not computed (no/negative income)

## Housing Unit Problems (2)  ----
# [lacks complete kitchen facilities, lacks complete plumbing facilities, overcrowded (a unit with more than 1 occupant per room), cost burdened (a unit where monthly housing cost as a % of hhld income exceeds 30%)]
# Has 1 or more of the 4 housing unit problems
# Has none of the 4 housing problems OR Cost burden cannot be computed, none of the other 3 housing problems

## Housing Unit Problems (3)  ----
# [lacks complete kitchen facilities, lacks complete plumbing facilities, overcrowded (a unit with more than 1 occupant per room), cost burdened (a unit where monthly housing cost as a % of hhld income exceeds 30%)]
# Has 1 or more of the 4 housing unit problems
# Has none of the 4 housing problems
# Cost burden cannot be computed, none of the above problems

## Housing Unit Problem Severity (7) ----
# Lacks complete plumbing or kitchen facilities
# With 1.51 or more persons per room, none of the needs above
# With 1.01 to 1.50 persons per room, none of the needs above
# Housing cost burden over 50%, none of the needs above
# Housing cost burden 30.1% to 50%, none of the needs above
# Cost burden cannot be computed, none of the above problems
# No housing unit problems

## Overcrowding (3) ----
# 1 or fewer persons per room
# 1.01 to 1.50 persons per room
# 1.51 or more persons per room

## Owner Affordability (4) ----
# Value less than or equal to VHUD50
# Value greater than VHUD50 and less than or equal to VHUD80
# Value greater than VHUD80 and less than or equal to VHUD100
# Value greater than VHUD100

## Presence of Children (2) ----
# Household contains 1 or more children age 6 or younger
# Household contains no children age 6 or younger

## Race (6) [Defined by race of Householder] ----
# White alone, non-Hispanic
# Black or African-American alone, non-Hispanic
# Asian alone, non-Hispanic
# American Indian or Alaska Native alone, non-Hispanic
# Pacific Islander alone, non-Hispanic
# Hispanic, any race

## Race (7) [Defined by race of Householder] ----
# White alone, non-Hispanic
# Black or African-American alone, non-Hispanic
# Asian alone, non-Hispanic
# American Indian or Alaska Native alone, non-Hispanic
# Pacific Islander alone, non-Hispanic
# Hispanic, any race
# Other (including multiple races, non-Hispanic)

## Renter Affordability (4) ----
# Rent less than or equal to RHUD30
# Rent greater than RHUD30 and less than or equal to RHUD50
# Rent greater than RHUD50 and less than or equal to RHUD80
# Rent greater than RHUD80

## Severe Housing Unit Problems (2)  ----
# [Severe housing problems: lacks complete kitchen facilities, lacks complete plumbing facilities, severely overcrowded (a unit with more than 1.5 occupant per room), severely cost burdened (a unit where monthly housing cost as a % of hhld income exceeds 50%)]
# Has 1 or more of the 4 severe housing unit problems
# Has none of the 4 severe housing problems OR Cost burden cannot be computed, none of the above severe housing problems 

## Substandard Housing (2) ----
# Lacks complete plumbing or kitchen facilities
# Has complete plumbing and kitchen facilities

## Tenure (2) ----
# Owner
# Renter

## Units in Structure (4) ----
# One unit in structure
# 2 to 4 units in structure
# 5 or more units in structure
# Other (mobile homes, etc)

## Year Structure Built (3) ----
# Structure built in 1980 or later
# Structure built between 1940 and 1979
# Structure built in 1939 or earlier 

## Year Structure Built (5) ----
# Structure built in 2000 or later
# Structure built between 1980 and 1999
# Structure built between 1960 and 1979
# Structure built between 1940 and 1959
# Structure built in 1939 or earlier



# loads -------------------------------------------------------------------

source(here::here("r", "libraries.r"))

# locations ---------------------------------------------------------------
chdir <- here::here("data", "CHAS")
chdir2019 <- path(chdir, "2015-2019")

# get data ----------------------------------------------------------------
nychas <- readRDS(path(chdir2019, "nychas.rds"))
glimpse(nychas)

# table1 ----
# Table 1	 Tenure (2) by Housing Unit Problems (2) by Household Income (5) by Race (6)	Universe: All occupied housing units
# the descriptions are in alpha order, put them in desired order
forder <- function(df, colname, prefix="lev"){
  # function to put a factor in order based on first variable numbers associated with each level
  df |> 
    select(vnum, desc=.data[[colname]]) |> 
    mutate(descname=colname) |> 
    group_by(desc) |>
    arrange(vnum) |>
    filter(row_number()==1) |>
    ungroup() |>
    arrange(vnum) |>
    mutate(order=row_number(),
           vlev=paste0(prefix, order))
}

t1 <- nychas |> 
  filter(table=="t1")

t1d1 <- forder(t1, "desc1", "tenure")
t1d2 <- forder(t1, "desc2", "problems")
t1d3 <- forder(t1, "desc3", "pcthamfi")
t1d4 <- forder(t1, "desc4", "race")

t1a <- t1 |> 
  mutate(fdesc1=factor(desc1, levels=t1d1$desc, labels=t1d1$vlev),
         fdesc2=factor(desc2, levels=t1d2$desc, labels=t1d2$vlev),
         fdesc3=factor(desc3, levels=t1d3$desc, labels=t1d3$vlev),
         fdesc4=factor(desc4, levels=t1d4$desc, labels=t1d4$vlev))
count(t1a, fdesc1, desc1)  # tenure
count(t1a, fdesc2, desc2) # problems
count(t1a, fdesc3, desc3) # pcthamfi
count(t1a, fdesc4, desc4)

## tenure ----
t1a |> 
  filter(fdesc2=="problems1", fdesc3=="pcthamfi1", fdesc4=="race1", estmoe=="est") |> 
  filter(stabbr=="NY", atype=="county") |> 
  select(geoid, stabbr, atype, shortname, fdesc1, value) |> 
  pivot_wider(names_from = fdesc1) |> 
  mutate(rpct=tenure3 / tenure1) |> 
  arrange(desc(rpct))

## any problem ----
# problems2 / problems1
t1a |> 
  filter(fdesc1!="tenure1", fdesc3=="pcthamfi1", fdesc4=="race1", estmoe=="est") |> 
  filter(stabbr=="NY", atype=="county") |> 
  select(geoid, stabbr, atype, shortname, fdesc1, fdesc2, value) |> 
  group_by(geoid, stabbr, atype, shortname, fdesc2) |> 
  summarise(value=sum(value)) |> 
  pivot_wider(names_from = c(fdesc2)) |> 
  mutate(probpct=problems2 / problems1) |> 
  arrange(desc(probpct))

# wide
glimpse(t1)
t1wide <- t1 |> 
  filter(estmoe=="est") |> 
  select(geoid, stabbr, atype, shortname, vname, value) |> 
  pivot_wider(names_from = vname)


# djb this is the way to do it ----
idvars <- c("geoid", "stabbr", "atype", "shortname", "cnty", "cntyname")
probpct <- t1 |> 
  filter(estmoe=="est", vnum %in% c(1:3, 75, 76)) |> 
  select(all_of(idvars), vname, value) |> 
  pivot_wider(names_from = vname) |> 
  mutate(own_probpct=t1_est3 / t1_est2,
         rent_probpct=t1_est76 / t1_est75,
         tot_probpct=(t1_est3 + t1_est76) / t1_est1,
         rentmown=rent_probpct - own_probpct) |> 
  # filter(stabbr=="NY", atype=="county") |> 
  # filter(atype=="state") |> 
  arrange(desc(tot_probpct))
summary(probpct)

probpct |> 
  filter(!is.na(rentmown)) |> 
  mutate(rentgtown = rentmown > 0) |> 
  count(rentgtown) |> 
  mutate(share=n / sum(n))

probpct |> 
  filter(atype=="place", t1_est1>=500) |> 
  filter(str_detect(shortname, "village"))

probpct |> 
  filter(atype=="cousub", t1_est1>=500) |> 
  arrange(desc(rent_probpct))

probpct |> 
  filter(atype=="cousub", t1_est1>=500, cnty=="115") |> 
  arrange(desc(rent_probpct))

probpct |> 
  filter(atype=="cousub", t1_est1>=500, cnty=="115") |> 
  arrange(desc(own_probpct))

probpct |> 
  filter(atype=="place", t1_est1>=500) |> 
  filter(str_detect(shortname, "village"), 
         str_detect_any(shortname, c("Cambridge", "Greenwich", "Argyle", "Schuylerville", "Edward", "Granville"))) |> 
  arrange(desc(rent_probpct))


  


